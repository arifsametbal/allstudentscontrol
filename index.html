<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rutin Takip Sistemi</title>
    
    <!-- K√ºt√ºphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { 
            font-family: 'Helvetica', 'Arial', sans-serif; 
            background-color: #fce4ec; 
            -webkit-tap-highlight-color: transparent;
        }
        .btn-press:active { transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ff80ab; border-radius: 3px; }
        .icon-select { 
            -webkit-appearance: none; appearance: none; text-align: center; text-align-last: center;
        }
        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* √ñzel Animasyonlar */
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="app" class="flex flex-col min-h-screen max-w-md mx-auto bg-gray-50 shadow-2xl relative overflow-hidden">

    <!-- BRANDING HEADER -->
    <div class="w-full bg-gray-900 text-white text-[10px] text-center py-1 font-bold tracking-[0.2em] uppercase select-none z-50">
        ARIF SAMET BAL
    </div>

    <!-- Y√úKLENƒ∞YOR -->
    <div v-if="loading" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-white/95 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-pink-500 mb-3"></div>
        <p class="text-pink-600 font-bold animate-pulse">ƒ∞≈ülem Yapƒ±lƒ±yor...</p>
    </div>

    <!-- 1. LOGIN EKRANI -->
    <div v-if="!currentUser" class="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-pink-100 to-purple-100">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border-4 border-white">
            <div class="text-center mb-6">
                <div class="text-6xl mb-2">üéì</div>
                <h1 class="text-2xl font-extrabold text-gray-800">Rutin Takip</h1>
                <p class="text-gray-400 text-sm">Giri≈ü Yapƒ±n</p>
            </div>

            <!-- Login Tabs -->
            <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                <button @click="loginMode = 'student'" :class="loginMode === 'student' ? 'bg-white shadow text-pink-500' : 'text-gray-500'" class="flex-1 py-2 rounded-lg font-bold text-sm transition-all">√ñƒürenci</button>
                <button @click="loginMode = 'admin'" :class="loginMode === 'admin' ? 'bg-white shadow text-purple-600' : 'text-gray-500'" class="flex-1 py-2 rounded-lg font-bold text-sm transition-all">Y√∂netici</button>
            </div>

            <form @submit.prevent="handleLogin" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">Kullanƒ±cƒ± Adƒ±</label>
                    <input v-model="loginForm.username" type="text" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-pink-500 outline-none transition" placeholder="√∂rn: ali">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">≈ûifre</label>
                    <input v-model="loginForm.password" type="password" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-pink-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" :class="loginMode === 'admin' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-pink-500 hover:bg-pink-600'" class="w-full text-white font-bold py-4 rounded-xl shadow-lg btn-press transition mt-2">
                    {{ loginMode === 'admin' ? 'Y√∂netici Giri≈üi' : '√ñƒürenci Giri≈üi' }}
                </button>
            </form>
            <p v-if="loginError" class="text-red-500 text-center text-sm font-bold mt-4 animate-pulse">{{ loginError }}</p>
        </div>
    </div>

    <!-- 2. Y√ñNETƒ∞Cƒ∞ PANELƒ∞ -->
    <div v-else-if="currentUser.role === 'admin' && !viewingUser" class="flex-1 flex flex-col bg-gray-50">
        <header class="bg-purple-700 text-white p-6 pb-8 rounded-b-3xl shadow-lg relative z-10">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold">Y√∂netici Paneli</h1>
                    <p class="text-purple-200 text-sm">√ñƒürenci Y√∂netimi</p>
                </div>
                <button @click="logout" class="bg-white/20 p-2 rounded-lg hover:bg-white/30 text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="absolute -bottom-6 left-6 right-6">
                <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase">Toplam √ñƒürenci</div>
                        <div class="text-2xl font-black text-purple-600">{{ userList.length }}</div>
                    </div>
                    <button @click="showAddUserModal = true" class="bg-purple-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg btn-press flex items-center gap-2">
                        <i class="fas fa-user-plus"></i> Ekle
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto pt-10 p-4 space-y-3">
            <div v-if="userList.length === 0" class="text-center py-10 text-gray-400">
                <i class="fas fa-users text-4xl mb-3 opacity-30"></i>
                <p>Hen√ºz √∂ƒürenci eklenmemi≈ü.</p>
            </div>
            
            <div v-for="user in userList" :key="user.userId" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group hover:border-purple-200 transition">
                <div class="flex items-center gap-3 cursor-pointer flex-1" @click="impersonateUser(user)">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-lg">
                        {{ user.username.charAt(0).toUpperCase() }}
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">{{ user.username }}</div>
                        <div class="text-xs text-gray-400">≈ûifre: {{ user.password }}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="impersonateUser(user)" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 text-xs font-bold px-3">
                        G√∂zat <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                    <button @click="deleteUser(user)" class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. KULLANICI ARAY√úZ√ú (Main App) -->
    <div v-else class="flex flex-col h-full bg-[#fce4ec]">
        
        <!-- √úST BAR -->
        <div v-if="viewingUser" class="bg-orange-500 text-white text-xs font-bold text-center py-2 px-4 shadow-md z-50 flex justify-between items-center">
            <span><i class="fas fa-eye"></i> ≈ûu an <u>{{ viewingUser.username }}</u> olarak g√∂r√ºnt√ºl√ºyorsunuz.</span>
            <button @click="viewingUser = null" class="bg-white text-orange-600 px-2 py-1 rounded text-[10px] font-bold uppercase hover:bg-gray-100">Y√∂neticiye D√∂n</button>
        </div>

        <header class="bg-pink-400 p-4 pb-2 text-white shadow-md z-10 transition-all duration-300" :class="{'bg-purple-600': editMode}">
            <div v-if="editMode" class="bg-yellow-300 text-yellow-900 text-xs font-bold text-center py-1 rounded mb-2 animate-pulse">D√úZENLEME MODU A√áIK</div>

            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded-full border-4 border-white bg-white/20 overflow-hidden shadow-sm relative group cursor-pointer flex items-center justify-center" @click="triggerFileUpload">
                        <img v-if="currentProfileImage" :src="currentProfileImage" class="w-full h-full object-cover">
                        <i v-else class="fas fa-camera text-2xl text-white/80"></i>
                    </div>
                    <div class="flex-1">
                        <div v-if="editMode">
                             <input v-model="currentAppTitle" class="bg-white/20 border border-white/50 rounded p-1 text-white font-bold w-full" placeholder="ƒ∞sim Giriniz...">
                        </div>
                        <div v-else>
                            <h1 class="text-xl font-bold leading-tight">{{ currentAppTitle || activeUsername }}</h1>
                            <p class="text-xs opacity-90 font-medium">‚ú® Hedeflerine ula≈ü!</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button v-if="currentUser.role === 'student'" @click="logout" class="bg-white/20 p-3 rounded-full w-10 h-10 flex items-center justify-center transition text-white hover:bg-red-500">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button @click="toggleEditMode" :class="editMode ? 'bg-green-400 text-white shadow-lg scale-110' : 'bg-white/20 text-white'" class="p-3 rounded-full w-10 h-10 flex items-center justify-center transition">
                        <i class="fas" :class="editMode ? 'fa-save' : 'fa-pen'"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center bg-white/10 p-2 rounded-xl backdrop-blur-sm mb-2">
                <button @click="changeWeek(-1)" class="p-2 hover:bg-white/20 rounded-full"><i class="fas fa-chevron-left"></i></button>
                <div class="flex gap-1 overflow-x-auto no-scrollbar">
                    <div v-for="day in weekDays" :key="day.dateStr" @click="selectDate(day.dateObj)"
                         :class="isSelected(day.dateObj) ? 'bg-white text-pink-500 transform scale-110 shadow-md' : 'text-white hover:bg-white/20'"
                         class="flex flex-col items-center justify-center w-10 h-12 rounded-lg cursor-pointer transition-all">
                        <span class="text-[10px] font-bold opacity-80">{{ day.name }}</span>
                        <span class="text-sm font-bold">{{ day.num }}</span>
                    </div>
                </div>
                <button @click="changeWeek(1)" class="p-2 hover:bg-white/20 rounded-full"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="flex items-center justify-center gap-3 bg-black/10 py-1 rounded mt-1 relative">
                <span class="text-xs font-bold">Se√ßili: {{ formatDateDisplay(selectedDate) }}</span>
                <div class="relative w-6 h-6 cursor-pointer">
                    <i class="fas fa-calendar-alt text-lg text-white absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></i>
                    <input type="date" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-20" @change="onManualDateChange">
                </div>
            </div>
        </header>

        <div class="flex p-2 gap-2 bg-pink-50 sticky top-0 z-30">
            <button @click="activeTab = 'rutin'" :class="activeTab === 'rutin' ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-pink-400 border border-pink-100'" class="flex-1 py-3 rounded-xl font-bold transition-all btn-press flex items-center justify-center gap-2"><i class="fas fa-heart"></i> Rutin</button>
            <button @click="activeTab = 'ders'" :class="activeTab === 'ders' ? 'bg-green-500 text-white shadow-lg' : 'bg-white text-green-500 border border-green-100'" class="flex-1 py-3 rounded-xl font-bold transition-all btn-press flex items-center justify-center gap-2"><i class="fas fa-book-open"></i> Ders</button>
        </div>

        <main class="flex-1 overflow-y-auto p-4 bg-gray-50 pb-20">
            <!-- RUTƒ∞N SEKME ƒ∞√áERƒ∞ƒûƒ∞ -->
            <div v-if="activeTab === 'rutin'" class="space-y-6">
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(act, index) in currentActivities" :key="act.id" class="relative group animate-slide-up" :style="{ animationDelay: index * 50 + 'ms' }">
                        <button v-if="editMode" @click="removeActivity(index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-md hover:bg-red-600 transition"><i class="fas fa-times text-xs"></i></button>
                        <div :class="act.color" class="w-full p-3 rounded-2xl shadow-sm border-b-4 border-black/5 flex flex-col items-center justify-center h-32 relative transition-all">
                            <div v-if="editMode" class="mb-1 w-full flex justify-center"><select v-model="act.icon" class="bg-white/50 border border-gray-300 text-gray-700 text-sm rounded p-1 w-3/4 icon-select"><option v-for="icon in iconOptions" :value="icon.val">{{ icon.label }}</option></select></div>
                            <button v-else @click="openActivityModal(act)" class="bg-white/40 w-12 h-12 flex items-center justify-center rounded-full mb-2 text-gray-700 text-2xl btn-press"><i :class="['fas', act.icon]"></i></button>
                            <div v-if="editMode" class="w-full flex justify-center mb-1"><select v-model="act.color" class="bg-white/50 border border-gray-300 text-xs rounded p-1 w-3/4"><option value="bg-pink-200">Pembe</option><option value="bg-blue-200">Mavi</option><option value="bg-green-200">Ye≈üil</option><option value="bg-yellow-200">Sarƒ±</option><option value="bg-purple-200">Mor</option><option value="bg-orange-200">Turuncu</option></select></div>
                            <input v-if="editMode" v-model="act.label" class="w-full text-center text-xs bg-white font-bold rounded p-1 border border-gray-300 text-gray-800" />
                            <span v-else class="font-bold text-gray-700 text-sm text-center leading-tight px-1 cursor-pointer" @click="openActivityModal(act)">{{ act.label }}</span>
                            <div v-if="!editMode && getDayActivityTotal(act.id) > 0" class="absolute top-2 right-2 bg-white/90 text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm pointer-events-none">{{ getDayActivityTotal(act.id) }} dk</div>
                        </div>
                    </div>
                    <button v-if="editMode" @click="addNewActivity" class="border-2 border-dashed border-gray-300 text-gray-400 bg-gray-50 rounded-2xl flex flex-col items-center justify-center h-32 hover:bg-gray-100 transition"><i class="fas fa-plus text-3xl mb-2"></i><span class="font-bold text-sm">Yeni Ekle</span></button>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-md border border-pink-100"><h3 class="font-bold text-pink-500 mb-4 flex items-center gap-2"><i class="fas fa-chart-pie"></i> G√ºnl√ºk Daƒüƒ±lƒ±m</h3><div class="h-48 relative"><canvas id="rutinChart"></canvas><div v-if="dailyActivities.length === 0" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm italic">Veri yok</div></div></div>
                <div class="space-y-2">
                    <div v-for="log in dailyActivities" :key="log.id" class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500"><i :class="['fas', getActivityIcon(log.type)]"></i></div><div><div class="font-bold text-gray-700 text-sm">{{ getActivityLabel(log.type) }}</div><div class="text-xs text-gray-400">{{ log.minutes }} dk <span v-if="log.pages">‚Ä¢ {{ log.pages }} Syf</span></div></div></div>
                        <div class="flex gap-2"><button @click="editLog(log, 'activity')" class="text-blue-400 hover:text-blue-600 p-2 bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button><button @click="editLog(log, 'activity_delete')" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded-lg"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'ders'" class="space-y-6">
                <div class="bg-white p-5 rounded-3xl shadow-md border-t-4 border-green-500 relative transition-all" :class="editMode ? 'border-yellow-400 ring-2 ring-yellow-200' : ''">
                    <div v-if="editMode" class="absolute top-0 right-0 bg-yellow-300 text-yellow-900 text-[10px] px-2 py-1 rounded-bl-xl font-bold">Lƒ∞STE D√úZENLEME</div>
                    <h3 class="font-bold text-green-700 mb-4 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> {{ editingId ? 'Kaydƒ± D√ºzenle' : (editMode ? 'Ders Listesini D√ºzenle' : 'Test Sonucu Gir') }}</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">{{ editMode ? 'Dersler (ƒ∞sim deƒüi≈ütirmek i√ßin tƒ±kla)' : 'Ders Se√ß' }}</label>
                            <div class="flex flex-wrap gap-2 pb-2">
                                <div v-for="(subj, index) in currentSubjects" :key="subj" class="relative group">
                                    <button @click="editMode ? renameSubject(index) : newTest.subject = subj" :class="getSubjectButtonClass(subj)" class="px-3 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition relative overflow-hidden">{{ subj }}<i v-if="editMode" class="fas fa-pen text-[10px] ml-1 opacity-50"></i></button>
                                    <button v-if="editMode" @click.stop="removeSubject(index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:scale-110 transition z-10"><i class="fas fa-times"></i></button>
                                </div>
                                <button v-if="editMode" @click="addSubject" class="px-3 py-2 rounded-lg text-sm font-bold bg-blue-100 text-blue-600 border border-blue-300 hover:bg-blue-200 transition"><i class="fas fa-plus"></i> Ekle</button>
                            </div>
                        </div>
                        <div v-if="!editMode || editingId" class="animate-slide-up">
                            <div><label class="text-xs font-bold text-gray-400 block mb-1">Toplam Soru</label><input type="number" v-model="newTest.total" class="w-full p-3 rounded-xl border-2 border-gray-200 text-center font-bold text-lg focus:border-green-500 outline-none" placeholder="20"></div>
                            <div class="grid grid-cols-3 gap-2 mt-2">
                                <div><label class="text-xs font-bold text-green-500 block mb-1 text-center">Doƒüru</label><input type="number" v-model="newTest.correct" class="w-full p-3 rounded-xl border-2 border-green-100 text-green-600 text-center font-bold outline-none" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-yellow-500 block mb-1 text-center">Bo≈ü</label><input type="number" v-model="newTest.empty" class="w-full p-3 rounded-xl border-2 border-yellow-100 text-yellow-600 text-center font-bold outline-none" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-red-500 block mb-1 text-center">Yanlƒ±≈ü</label><div class="w-full p-3 rounded-xl bg-red-50 border-2 border-red-100 text-red-500 text-center font-bold">{{ calculateWrong }}</div></div>
                            </div>
                            <div class="flex gap-2 mt-2"><button v-if="editingId" @click="cancelEdit" class="w-1/3 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl shadow-lg btn-press mt-2">ƒ∞PTAL</button><button @click="saveTest" :disabled="!isValidTest" class="flex-1 bg-green-500 disabled:bg-gray-300 text-white font-bold py-3 rounded-xl shadow-lg btn-press mt-2">{{ editingId ? 'G√úNCELLE' : 'KAYDET' }}</button></div>
                            <p v-if="editingId" class="text-xs text-center text-red-500 font-bold mt-2">‚ö†Ô∏è Silmek i√ßin Toplam Soru'yu 0 yapƒ±p g√ºncelleyin.</p>
                        </div>
                        <div v-else class="text-center py-4 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200"><i class="fas fa-info-circle mb-1 block text-lg"></i>Ders listesini d√ºzenliyorsunuz.<br>Veri girmek i√ßin d√ºzenleme modunu kapatƒ±n.</div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-md border border-green-100"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-green-600 flex items-center gap-2"><i class="fas fa-chart-line"></i> Ba≈üarƒ± Grafiƒüi</h3><select v-model="chartSubject" class="text-xs border rounded p-1"><option value="all">Genel</option><option v-for="s in currentSubjects" :value="s">{{s}}</option></select></div><div class="h-48 relative"><canvas id="dersChart"></canvas><div v-if="filteredRecords.length === 0" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm italic">Kayƒ±t yok</div></div></div>
                <div class="space-y-2">
                    <div v-for="record in dailyTests" :key="record.id" class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                        <div><div class="font-bold text-gray-700 text-sm">{{ record.subject }}</div><div class="text-xs text-gray-400">{{ record.total }} Soru</div></div>
                        <div class="flex gap-2"><span class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs font-bold">D:{{record.correct}}</span><span class="px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-xs font-bold">B:{{record.empty}}</span><span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-bold">Y:{{record.wrong}}</span></div>
                        <div class="flex gap-2 ml-2"><button @click="editLog(record, 'test')" class="text-blue-400 hover:text-blue-600 p-2 bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button><button @click="editLog(record, 'test_delete')" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded-lg"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ADD USER MODAL (ADMIN) -->
    <div v-if="showAddUserModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl animate-slide-up">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni √ñƒürenci Ekle</h3>
            <div class="space-y-3">
                <input v-model="newUserForm.username" type="text" placeholder="Kullanƒ±cƒ± Adƒ±" class="w-full p-3 border-2 border-gray-200 rounded-xl outline-none focus:border-purple-500">
                <input v-model="newUserForm.password" type="text" placeholder="≈ûifre" class="w-full p-3 border-2 border-gray-200 rounded-xl outline-none focus:border-purple-500">
            </div>
            <div class="flex gap-2 mt-4">
                <button @click="showAddUserModal = false" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">ƒ∞ptal</button>
                <button @click="addNewUser" class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- AKTIVITE MODALI -->
    <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm relative animate-slide-up shadow-2xl border-4 border-pink-200">
            <button @click="showModal = false; editingId = null;" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2"><i :class="['fas', currentActivity?.icon, 'text-pink-400']"></i> {{ currentActivity?.label }}</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">S√ºre (Dakika)</label><input type="number" v-model="modalMinutes" autofocus class="w-full text-center text-4xl font-bold p-3 border-2 border-pink-200 rounded-2xl outline-none focus:border-pink-500 text-gray-700" placeholder="0"></div>
                <div v-if="currentActivity?.id === 'reading'"><label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Okunan Sayfa</label><input type="number" v-model="modalPages" class="w-full text-center text-xl font-bold p-3 border-2 border-orange-200 rounded-xl outline-none focus:border-orange-500 text-orange-600" placeholder="0"></div>
                <p v-if="editingId" class="text-xs text-center text-red-400">Silmek i√ßin s√ºreyi 0 yapƒ±p g√ºncelleyin.</p>
                <button @click="confirmActivity" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg btn-press text-lg mt-4">{{ editingId ? 'G√úNCELLE' : 'KAYDET' }}</button>
            </div>
        </div>
    </div>

    <!-- GENEL MODAL -->
    <div v-if="genericModal.show" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/70 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm relative shadow-2xl animate-bounce-slow">
            <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">{{ genericModal.title }}</h3>
            <p v-if="genericModal.message" class="text-sm text-gray-600 mb-4 text-center">{{ genericModal.message }}</p>
            <div v-if="genericModal.type === 'input'" class="mb-4"><input type="text" v-model="genericModal.inputValue" class="w-full p-3 border-2 border-gray-200 rounded-xl text-center text-lg outline-none focus:border-blue-500" :placeholder="genericModal.placeholder"></div>
            <div class="flex gap-2"><button v-if="genericModal.type !== 'alert'" @click="genericModal.show = false" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-300 transition">ƒ∞ptal</button><button @click="confirmGenericModal" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">{{ genericModal.confirmText || 'Tamam' }}</button></div>
        </div>
    </div>

    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="onFileSelected">
</div>

<script>
    // G√úNCEL SCRƒ∞PT Lƒ∞NKƒ∞ BURAYA EKLENDƒ∞ ‚úÖ
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1rQrHGVDovB8v9Toe4RUi16ldXo9zbTrFWxIe07t-b9xX0DNdsSGSHPM8X7T1qyMS/exec"; 

    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    createApp({
        setup() {
            // STATE VARIABLES
            const loading = ref(false);
            const currentUser = ref(null); // { userId: '123', username: 'ali', role: 'student'|'admin' }
            const viewingUser = ref(null); // Admin'in o an g√∂r√ºnt√ºlediƒüi kullanƒ±cƒ±
            const loginMode = ref('student');
            const loginForm = ref({ username: '', password: '' });
            const loginError = ref('');
            const showAddUserModal = ref(false);
            const newUserForm = ref({ username: '', password: '' });

            // DATA CONTAINERS
            const userList = ref([]);
            const activityLog = ref([]);
            const testRecords = ref([]);
            const userSettings = ref({}); // userId -> { appTitle, profileImage, activities, subjects }

            // APP VARIABLES
            const showWelcome = ref(true);
            const activeTab = ref('rutin');
            const selectedDate = ref(new Date());
            const editMode = ref(false);
            const editingId = ref(null); 
            const showModal = ref(false);
            const currentActivity = ref(null);
            const modalMinutes = ref('');
            const modalPages = ref('');
            const newTest = ref({ subject: 'T√ºrk√ße', total: '', correct: '', empty: '' });
            const chartSubject = ref('all');
            const genericModal = ref({ show: false, type: 'alert', title: '', message: '', inputValue: '', placeholder: '', confirmText: 'Tamam', onConfirm: null });
            
            let pieChart = null, lineChart = null;

            // --- COMPUTED PROPERTIES FOR ACTIVE USER ---
            // Hangi kullanƒ±cƒ±nƒ±n verisini g√∂steriyoruz? (Login olan √∂ƒürenci mi yoksa Admin'in se√ßtiƒüi mi?)
            const activeUserId = computed(() => viewingUser.value ? viewingUser.value.userId : (currentUser.value ? currentUser.value.userId : null));
            const activeUsername = computed(() => viewingUser.value ? viewingUser.value.username : (currentUser.value ? currentUser.value.username : ''));

            // Aktif kullanƒ±cƒ±nƒ±n ayarlarƒ±nƒ± getir (Yoksa varsayƒ±lanlarƒ± kullan)
            const currentSettings = computed(() => userSettings.value[activeUserId.value] || {});
            
            const currentAppTitle = computed({
                get: () => currentSettings.value.appTitle || activeUsername.value,
                set: (val) => updateSetting('appTitle', val)
            });
            const currentProfileImage = computed(() => currentSettings.value.profileImage || null);
            
            const defaultActivities = [
                { id: 'study', label: 'Ders √áalƒ±≈üma', icon: 'fa-clock', color: 'bg-indigo-200' },
                { id: 'reading', label: 'Kitap Okuma', icon: 'fa-book-open', color: 'bg-orange-200' },
                { id: 'saz', label: 'Saz √áalƒ±≈ü', icon: 'fa-music', color: 'bg-yellow-200' },
                { id: 'skate', label: 'Paten S√ºr', icon: 'fa-skating', color: 'bg-blue-200' }
            ];
            const currentActivities = computed(() => currentSettings.value.activities || defaultActivities);
            
            const defaultSubjects = ["T√ºrk√ße", "Matematik", "Hayat Bilgisi", "Fen Bilimleri", "ƒ∞ngilizce"];
            const currentSubjects = computed(() => currentSettings.value.subjects || defaultSubjects);

            const iconOptions = [
                { val: 'fa-clock', label: 'Saat' }, { val: 'fa-book-open', label: 'Kitap A√ßƒ±k' }, 
                { val: 'fa-book', label: 'Kitap Kapalƒ±' }, { val: 'fa-music', label: 'M√ºzik' },
                { val: 'fa-skating', label: 'Paten' }, { val: 'fa-bicycle', label: 'Bisiklet' },
                { val: 'fa-cat', label: 'Kedi' }, { val: 'fa-dog', label: 'K√∂pek' },
                { val: 'fa-palette', label: 'Resim' }, { val: 'fa-comments', label: 'Sohbet' },
                { val: 'fa-utensils', label: 'Yemek' }, { val: 'fa-tv', label: 'TV' },
                { val: 'fa-gamepad', label: 'Oyun' }, { val: 'fa-bed', label: 'Uyku' },
                { val: 'fa-heart', label: 'Kalp' }, { val: 'fa-star', label: 'Yƒ±ldƒ±z' }
            ];

            // --- DATA FILTERING ---
            const formatDateKey = (d) => d.toLocaleDateString('tr-TR');
            const selectedDateKey = computed(() => formatDateKey(selectedDate.value));

            // Sadece aktif kullanƒ±cƒ±nƒ±n verilerini filtrele
            const dailyActivities = computed(() => activityLog.value.filter(l => l.userId === activeUserId.value && l.date === selectedDateKey.value && Number(l.minutes) > 0));
            const dailyTests = computed(() => testRecords.value.filter(t => t.userId === activeUserId.value && t.date === selectedDateKey.value && Number(t.total) > 0));

            const calculateWrong = computed(() => {
                const total = Number(newTest.value.total) || 0;
                const correct = Number(newTest.value.correct) || 0;
                const empty = Number(newTest.value.empty) || 0;
                const wrong = total - correct - empty;
                return wrong > 0 ? wrong : 0;
            });
            const isValidTest = computed(() => newTest.value.total !== '' && newTest.value.correct !== '' && calculateWrong.value >= 0);
            
            const filteredRecords = computed(() => {
                let recs = testRecords.value.filter(t => t.userId === activeUserId.value && Number(t.total) > 0);
                if (chartSubject.value === 'all') return recs;
                return recs.filter(r => r.subject === chartSubject.value);
            });
            
            const weekDays = computed(() => {
                const curr = new Date(selectedDate.value);
                const day = curr.getDay();
                const diff = curr.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(curr.setDate(diff));
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday); d.setDate(monday.getDate() + i);
                    days.push({ name: d.toLocaleDateString('tr-TR', { weekday: 'short' }), num: d.getDate(), dateObj: new Date(d), dateStr: formatDateKey(d) });
                }
                return days;
            });

            // --- WATCHERS ---
            watch([dailyActivities, activeTab], () => { if(activeTab.value === 'rutin' && (currentUser.value || viewingUser.value)) nextTick(renderPieChart); }, { deep: true });
            watch([filteredRecords, activeTab, chartSubject], () => { if(activeTab.value === 'ders' && (currentUser.value || viewingUser.value)) nextTick(renderLineChart); }, { deep: true });

            // --- LOGIN & USER MANAGEMENT ---
            const handleLogin = () => {
                loginError.value = '';
                if(loginMode.value === 'admin') {
                    if(loginForm.value.username === 'arifsametbal' && loginForm.value.password === '930770') {
                        currentUser.value = { userId: 'admin', username: 'Y√∂netici', role: 'admin' };
                    } else {
                        loginError.value = 'Hatalƒ± y√∂netici bilgisi!';
                    }
                } else {
                    const user = userList.value.find(u => u.username === loginForm.value.username && u.password === loginForm.value.password);
                    if(user) {
                        currentUser.value = { ...user, role: 'student' };
                    } else {
                        loginError.value = 'Kullanƒ±cƒ± bulunamadƒ±!';
                    }
                }
            };

            const logout = () => {
                currentUser.value = null;
                viewingUser.value = null;
                loginForm.value = { username: '', password: '' };
                editMode.value = false;
            };

            const addNewUser = async () => {
                if(!newUserForm.value.username || !newUserForm.value.password) return;
                
                loading.value = true;
                const uniqueId = Date.now().toString();
                const newUserId = 'u_' + uniqueId;
                
                const newUser = {
                    id: uniqueId, 
                    dataType: 'user_account',
                    userId: newUserId,
                    username: newUserForm.value.username,
                    password: newUserForm.value.password
                };
                
                const initialSettings = {
                    id: 's_' + uniqueId,
                    dataType: 'settings',
                    userId: newUserId,
                    appTitle: newUser.username,
                    activities: defaultActivities,
                    subjects: defaultSubjects
                };

                try {
                    // Veriyi no-cors ile g√∂nderiyoruz, cevap alamayƒ±z ama hata vermemeli
                    await sendDataToGoogle(newUser);
                    // Bekleyip diƒüerini g√∂nderelim
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await sendDataToGoogle(initialSettings);
                    
                    userList.value.push(newUser);
                    userSettings.value[newUserId] = initialSettings;
                    
                    showAddUserModal.value = false;
                    newUserForm.value = { username: '', password: '' };
                    showAlert("Ba≈üarƒ±lƒ±", "Yeni √∂ƒürenci kaydedildi.");
                } catch (e) {
                    console.error(e);
                    showAlert("Hata", "Kayƒ±t sƒ±rasƒ±nda bir sorun olu≈ütu.");
                } finally {
                    loading.value = false;
                }
            };

            const deleteUser = (user) => {
                showConfirm('√ñƒürenciyi Sil', `${user.username} adlƒ± √∂ƒürenciyi silmek istediƒüinize emin misiniz?`, async () => {
                    loading.value = true;
                    try {
                        userList.value = userList.value.filter(u => u.userId !== user.userId);
                        await sendDataToGoogle({ dataType: 'delete', deleteId: user.id }); 
                    } finally {
                        loading.value = false;
                    }
                });
            };

            const impersonateUser = (user) => {
                viewingUser.value = user;
                activeTab.value = 'rutin';
                nextTick(() => { renderPieChart(); });
            };

            // --- CORE FUNCTIONS ---
            const updateSetting = async (key, val) => {
                if(!userSettings.value[activeUserId.value]) userSettings.value[activeUserId.value] = {};
                userSettings.value[activeUserId.value][key] = val;
                await saveSettings();
            };

            const saveSettings = async () => {
                const settings = userSettings.value[activeUserId.value];
                const uniqueId = Date.now().toString();
                const payload = {
                    id: settings.id || 's_' + uniqueId, 
                    dataType: 'settings',
                    userId: activeUserId.value,
                    appTitle: settings.appTitle,
                    profileImage: settings.profileImage,
                    activities: settings.activities,
                    subjects: settings.subjects
                };
                if (!settings.id) userSettings.value[activeUserId.value].id = payload.id;
                await sendDataToGoogle(payload);
            };

            const toggleEditMode = () => { editMode.value = !editMode.value; if(!editMode.value) saveSettings(); };
            const selectDate = (date) => selectedDate.value = date;
            const changeWeek = (dir) => { const d = new Date(selectedDate.value); d.setDate(d.getDate() + (dir * 7)); selectedDate.value = d; };
            const formatDateDisplay = (date) => date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' });
            const isSelected = (d) => formatDateKey(d) === selectedDateKey.value;
            const onManualDateChange = (e) => { if(e.target.value) selectedDate.value = new Date(e.target.value); };

            // --- FILE UPLOAD ---
            const triggerFileUpload = () => {
                if(editMode.value) document.querySelector('input[type=file]').click();
                else showAlert("Uyarƒ±", "Fotoƒüraf deƒüi≈ütirmek i√ßin √∂nce d√ºzenleme (kalem) ikonuna basmalƒ±sƒ±n.");
            };
            const onFileSelected = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { 
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 150;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);
                            updateSetting('profileImage', compressedBase64);
                        };
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- ACTIVITY & SUBJECT MANAGEMENT ---
            const addNewActivity = () => { 
                const acts = [...currentActivities.value];
                acts.push({ id: 'act_' + Date.now(), label: 'Yeni', icon: 'fa-star', color: 'bg-gray-200' });
                updateSetting('activities', acts);
            };
            const removeActivity = (index) => { 
                showConfirm('Aktivite Sil', 'Bu aktiviteyi kaldƒ±rmak istediƒüine emin misin?', () => {
                    const acts = [...currentActivities.value];
                    acts.splice(index, 1);
                    updateSetting('activities', acts);
                });
            };
            const addSubject = () => {
                showInput('Yeni Ders Ekle', 'Ders Adƒ± Giriniz', '', (val) => {
                    if(val) {
                        const trimmedName = val.trim();
                        if(!currentSubjects.value.includes(trimmedName)) {
                            const subs = [...currentSubjects.value];
                            subs.push(trimmedName);
                            updateSetting('subjects', subs);
                        } else showAlert("Hata", "Bu ders zaten listenizde var!");
                    }
                });
            };
            const renameSubject = (index) => {
                const oldName = currentSubjects.value[index];
                showInput('Ders Adƒ±nƒ± Deƒüi≈ütir', 'Yeni Ad', oldName, (newName) => {
                    if(newName && newName !== oldName) {
                        const trimmedNew = newName.trim();
                        if(currentSubjects.value.includes(trimmedNew)) { showAlert("Hata", "Bu isimde bir ders zaten var."); return; }
                        
                        const subs = [...currentSubjects.value];
                        subs[index] = trimmedNew;
                        updateSetting('subjects', subs);

                        testRecords.value.forEach(record => {
                            if(record.userId === activeUserId.value && record.subject === oldName) record.subject = trimmedNew;
                        });
                        if(newTest.value.subject === oldName) newTest.value.subject = trimmedNew;
                    }
                });
            };
            const removeSubject = (index) => { 
                const subjName = currentSubjects.value[index];
                showConfirm('Dersi Sil', `'${subjName}' dersini silmek istediƒüine emin misin?`, () => {
                    const subs = [...currentSubjects.value];
                    subs.splice(index, 1);
                    updateSetting('subjects', subs);
                    if(newTest.value.subject === subjName && subs.length > 0) newTest.value.subject = subs[0];
                });
            };
            const getSubjectButtonClass = (subj) => {
                if (editMode.value) return 'bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200';
                return newTest.value.subject === subj ? 'bg-green-500 text-white shadow-md transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200';
            };

            // --- DATA OPERATIONS (CRUD) ---
            const sendDataToGoogle = async (payload) => {
                if(!GOOGLE_SCRIPT_URL) return;
                
                // ID ve userID kontrolleri
                if (!payload.id) payload.id = 'id_' + Date.now() + Math.random().toString(36).substr(2, 9);
                if(!payload.userId && activeUserId.value) payload.userId = activeUserId.value;
                
                // CRITICAL FIX: Use no-cors for POST to avoid cross-origin blocking on redirects
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8",
                    },
                    body: JSON.stringify(payload)
                });
            };

            const deleteLog = async (id, type) => {
                showConfirm("Silme Onayƒ±", "Kalƒ±cƒ± olarak silmek istiyor musunuz?", async () => {
                    loading.value = true;
                    try {
                        if(type === 'activity') activityLog.value = activityLog.value.filter(x => x.id !== id);
                        else testRecords.value = testRecords.value.filter(x => x.id !== id);
                        await sendDataToGoogle({ dataType: 'delete', deleteId: id });
                        nextTick(() => { if(activeTab.value === 'rutin') renderPieChart(); if(activeTab.value === 'ders') renderLineChart(); });
                    } finally {
                        loading.value = false;
                    }
                });
            };

            const editLog = (item, type) => {
                editingId.value = item.id;
                if (type.includes('delete')) {
                    showConfirm("Silme ƒ∞≈ülemi", "Bu kaydƒ± silmek i√ßin deƒüerlerini 0 yaparak g√ºncellemek ister misiniz?", () => {
                        if(type.startsWith('activity')) {
                             currentActivity.value = currentActivities.value.find(a => a.id === item.type);
                             modalMinutes.value = 0; modalPages.value = 0;
                             confirmActivity();
                        } else {
                             newTest.value = { ...item, total: 0, correct: 0, empty: 0 };
                             saveTest();
                        }
                    });
                    return; 
                }
                if(type.startsWith('activity')) {
                    const actDef = currentActivities.value.find(a => a.id === item.type);
                    currentActivity.value = actDef || { icon: 'fa-star', label: 'Bilinmeyen' };
                    modalMinutes.value = type.includes('delete') ? 0 : item.minutes;
                    modalPages.value = type.includes('delete') ? 0 : item.pages;
                    showModal.value = true;
                } else {
                    newTest.value = {
                        subject: item.subject,
                        total: type.includes('delete') ? 0 : item.total,
                        correct: type.includes('delete') ? 0 : item.correct,
                        empty: type.includes('delete') ? 0 : item.empty
                    };
                    document.querySelector('header').scrollIntoView({ behavior: 'smooth' });
                }
            };
            const cancelEdit = () => { editingId.value = null; newTest.value = { subject: 'T√ºrk√ße', total: '', correct: '', empty: '' }; };
            const openActivityModal = (act) => { if(editMode.value) return; editingId.value = null; currentActivity.value = act; modalMinutes.value = ''; modalPages.value = ''; showModal.value = true; };
            
            const confirmActivity = async () => {
                if(modalMinutes.value === '') return; 
                loading.value = true;
                const payload = { 
                    id: editingId.value || Date.now().toString(), 
                    userId: activeUserId.value,
                    type: currentActivity.value.id, 
                    minutes: Number(modalMinutes.value), 
                    pages: Number(modalPages.value) || 0, 
                    date: selectedDateKey.value,
                    dataType: 'activity' 
                };
                if(editingId.value) {
                     const idx = activityLog.value.findIndex(x => x.id === editingId.value);
                     if(idx !== -1) activityLog.value[idx] = payload;
                     payload.dataType = 'update';
                } else activityLog.value.push(payload);
                
                try {
                    await sendDataToGoogle(payload);
                    showModal.value = false;
                    editingId.value = null;
                } catch(e) {
                    showAlert("Hata", "Kaydedilemedi.");
                } finally {
                    loading.value = false;
                }
            };

            const saveTest = async () => {
                if(!isValidTest.value) return;
                loading.value = true;
                const payload = { 
                    id: editingId.value || Date.now().toString(), 
                    userId: activeUserId.value,
                    subject: newTest.value.subject, 
                    total: Number(newTest.value.total), 
                    correct: Number(newTest.value.correct), 
                    empty: Number(newTest.value.empty) || 0, 
                    wrong: calculateWrong.value, 
                    date: selectedDateKey.value, 
                    isoDate: selectedDate.value.toISOString(),
                    dataType: 'test'
                };
                if(editingId.value) {
                    const idx = testRecords.value.findIndex(x => x.id === editingId.value);
                    if(idx !== -1) testRecords.value[idx] = payload;
                    payload.dataType = 'update';
                } else testRecords.value.push(payload);
                
                try {
                    await sendDataToGoogle(payload);
                    newTest.value.correct = ''; newTest.value.empty = '';
                    editingId.value = null;
                } catch(e) {
                    showAlert("Hata", "Test kaydedilemedi.");
                } finally {
                    loading.value = false;
                }
            };
            
            // --- HELPERS ---
            const getDayActivityTotal = (actId) => dailyActivities.value.filter(x => x.type === actId).reduce((sum, x) => sum + x.minutes, 0);
            const getActivityLabel = (id) => currentActivities.value.find(a => a.id === id)?.label || 'Bilinmeyen';
            const getActivityIcon = (id) => currentActivities.value.find(a => a.id === id)?.icon || 'fa-star';
            
            // --- MODALS ---
            const showInput = (title, placeholder, initialValue, callback) => { genericModal.value = { show: true, type: 'input', title, placeholder, inputValue: initialValue, confirmText: 'Kaydet', onConfirm: callback }; };
            const showConfirm = (title, message, callback) => { genericModal.value = { show: true, type: 'confirm', title, message, inputValue: '', confirmText: 'Evet', onConfirm: callback }; };
            const showAlert = (title, message) => { genericModal.value = { show: true, type: 'alert', title, message, inputValue: '', confirmText: 'Tamam', onConfirm: () => { genericModal.value.show = false; } }; };
            const confirmGenericModal = () => { if(genericModal.value.onConfirm) genericModal.value.onConfirm(genericModal.value.inputValue); genericModal.value.show = false; };

            // --- CHARTS ---
            const renderPieChart = () => {
                const ctx = document.getElementById('rutinChart');
                if(!ctx) return; if(pieChart) pieChart.destroy();
                const summary = {}; dailyActivities.value.forEach(x => { summary[x.type] = (summary[x.type] || 0) + x.minutes; });
                const labels = Object.keys(summary).map(k => getActivityLabel(k)); const data = Object.values(summary);
                const colors = ['#FFCDD2', '#F8BBD0', '#E1BEE7', '#D1C4E9', '#C5CAE9', '#BBDEFB', '#B3E5FC', '#B2EBF2', '#B2DFDB', '#C8E6C9'];
                pieChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } } });
            };
            const renderLineChart = () => {
                const ctx = document.getElementById('dersChart');
                if(!ctx) return; if(lineChart) lineChart.destroy();
                if (filteredRecords.value.length === 0) return;
                const sorted = [...filteredRecords.value].sort((a,b) => new Date(a.isoDate) - new Date(b.isoDate)); const last10 = sorted.slice(-10);
                const labels = last10.map(x => x.date.substring(0, 5)); const data = last10.map(x => (x.correct / x.total) * 100);
                lineChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Ba≈üarƒ± Y√ºzdesi (%)', data: data, borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
            };

            const fetchDataFromGoogle = async () => {
                if(!GOOGLE_SCRIPT_URL) return;
                loading.value = true;
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL, { redirect: "follow" }); 
                    if (!res.ok) throw new Error("Sunucu yanƒ±t vermedi");
                    const data = await res.json();
                    
                    userList.value = data.filter(item => item.dataType === 'user_account');
                    activityLog.value = data.filter(item => item.dataType === 'activity' && Number(item.minutes) > 0);
                    testRecords.value = data.filter(item => item.dataType === 'test' && Number(item.total) > 0);
                    
                    const allSettings = data.filter(item => item.dataType === 'settings');
                    const settingsMap = {};
                    allSettings.forEach(s => {
                        if(s.userId) settingsMap[s.userId] = s; 
                    });
                    userSettings.value = settingsMap;

                } catch(err) { 
                    console.warn("Google Sheets Baƒülantƒ± Hatasƒ±:", err); 
                    showAlert("Baƒülantƒ± Hatasƒ±", "Verilere eri≈üilemedi. L√ºtfen Google Apps Script daƒüƒ±tƒ±m ayarlarƒ±nda 'Eri≈üim yetkisi'nin (Who has access) 'Herkes' (Anyone) olarak se√ßildiƒüinden emin olun.");
                } 
                finally { loading.value = false; }
            };

            onMounted(() => { fetchDataFromGoogle(); });

            return {
                loading, currentUser, viewingUser, loginMode, loginForm, loginError, showAddUserModal, newUserForm,
                userList, activityLog, testRecords, userSettings,
                showWelcome, activeTab, selectedDate, editMode, editingId,
                showModal, currentActivity, modalMinutes, modalPages, newTest, calculateWrong, isValidTest, chartSubject,
                genericModal, confirmGenericModal,
                handleLogin, logout, addNewUser, deleteUser, impersonateUser,
                toggleEditMode, selectDate, changeWeek, formatDateDisplay, isSelected, onManualDateChange,
                triggerFileUpload, onFileSelected, addNewActivity, removeActivity, addSubject, removeSubject, renameSubject, getSubjectButtonClass,
                editLog, deleteLog, cancelEdit, openActivityModal, confirmActivity, saveTest,
                getDayActivityTotal, getActivityLabel, getActivityIcon,
                activeUserId, activeUsername, currentAppTitle, currentProfileImage, currentActivities, currentSubjects,
                dailyActivities, dailyTests, filteredRecords, weekDays, selectedDateKey
            };
        }
    }).mount('#app');
</script>
</body>
</html>